# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

schedules:
- cron: "0 8 * * *"
  displayName: Build and push sonic-slave-* images
  branches:
    include:
    - master
  always: true

trigger: none
pr: none

parameters:
- name: 'arches'
  type: object
  default: 
  - amd64
  - armhf
  - arm64
- name: 'dists'
  type: object
  default:
  - buster
  - stretch
  - jessie
- name: registry_server
  type: string
  default: sonicdev
- name: registry_tail
  type: string
  default: -microsoft

stages:
- stage: Build
  jobs:
  - ${{ each dist in parameters.dists }}:
    - ${{ if endswith(variables['Build.DefinitionName'], dist) }}:
      - ${{ each arch in parameters.arches }}:
        - job: Build_${{ dist }}_${{ arch }}
          timeoutInMinutes: 360
          pool: sonicbld
          steps:
          - template: cleanup.yml
          - checkout: self
            clean: true
            submodules: recursive
          - bash: |
              set -ex

              SLAVE_DIR=sonic-slave-${{ dist }}
              if [ x${{ arch }} == x"amd64" ]; then
                SLAVE_BASE_IMAGE=${SLAVE_DIR}
              else
                SLAVE_BASE_IMAGE=${SLAVE_DIR}-${{ arch }}
              fi

              tmpfile=$(mktemp)

              echo ${{ arch }} > .arch

              DOCKER_DATA_ROOT_FOR_MULTIARCH=/data/march/docker BLDENV=${{ dist }} make -f Makefile.work sonic-slave-build | tee $tmpfile
              SLAVE_BASE_TAG=$(grep "^Checking sonic-slave-base image:" $tmpfile | awk -F ':' '{print $3}')
              SLAVE_TAG=$(grep "^Checking sonic-slave image:" $tmpfile | awk -F ':' '{print $3}')

              mkdir -p target

              docker tag $SLAVE_BASE_IMAGE:$SLAVE_BASE_TAG $REGISTRY_SERVER/$SLAVE_BASE_IMAGE:latest
              docker tag $SLAVE_BASE_IMAGE:$SLAVE_BASE_TAG $REGISTRY_SERVER/$SLAVE_BASE_IMAGE:$SLAVE_BASE_TAG
              set +x
              echo "##vso[task.setvariable variable=VARIABLE_SLAVE_BASE_IMAGE]$SLAVE_BASE_IMAGE"
              echo "##vso[task.setvariable variable=VARIABLE_SLAVE_BASE_TAG]$SLAVE_BASE_TAG"
            env:
              REGISTRY_SERVER: ${{ parameters.registry_server }}${{ parameters.registry_tail }}.azurecr.io
            displayName: Build sonic-slave-${{ dist }}-${{ arch }}

          - task: Docker@2
            displayName: Upload image
            inputs:
              containerRegistry: ${{ parameters.registry_server }}
              repository: $(VARIABLE_SLAVE_BASE_IMAGE)
              command: push
              tags: |
                $(VARIABLE_SLAVE_BASE_TAG)
                latest
