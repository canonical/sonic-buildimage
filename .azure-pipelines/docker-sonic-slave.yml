# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml
# Build and push sonic-slave-[buster|jessie|stretch] images for amd64/armhf/arm64
resources:
  repositories:
  - repository: buildimage
    type: github
    name: Azure/sonic-buildimage
    ref: master
    endpoint: build

pr: none
trigger:
  branches:
    include:
    - master
    - 202???
  paths:
    include:
    - sonic-slave-jessie
    - sonic-slave-stretch
    - sonic-slave-buster
    - sonic-slave-bullseye
    - src/sonic-build-hooks
    - files/build/versions

parameters:
- name: 'arches'
  type: object
  default:
  - amd64
  - armhf
  - arm64
- name: 'dists'
  type: object
  default:
  - bullseye
  - buster
  - stretch
  - jessie
- name: registry_url
  type: string
  default: sonicdev-microsoft.azurecr.io
- name: registry_conn
  type: string
  default: sonicdev

stages:
- stage: Build
  jobs:
  - ${{ each dist in parameters.dists }}:
    - ${{ if endswith(variables['Build.DefinitionName'], dist) }}:
      - template: '/.azure-pipelines/docker-sonic-slave-template.yml@buildimage'
        parameters:
          pool: sonicbld
          arch: amd64
          dist: ${{ dist }}
      - template: '/.azure-pipelines/docker-sonic-slave-template.yml@buildimage'
        parameters:
          pool: sonicbld-arm64
          arch: arm64
          dist: ${{ dist }}
      - template: '/.azure-pipelines/docker-sonic-slave-template.yml@buildimage'
        parameters:
          pool: sonicbld-armhf
          arch: armhf
          dist: ${{ dist }}
