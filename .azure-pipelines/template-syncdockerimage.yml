parameters:
- name: platforms
  type: object
  default:
  - vs
  - barefoot
  - broadcom
  - mellanox
  - centec-arm64
  - centec
  - nephos
  - innovium
  - marvell-armhf
  - generic

jobs:
- job: Build
  pool: sonicbld
  timeoutInMinutes: 120
  variables:
  - group: Debian-Mirror-Common
  steps:
  - checkout: self
    clean: true
  - ${{ each platform in parameters.platforms }}:
    - task: DownloadPipelineArtifact@2
      displayName: Download ${{ platform }} versions-docker
      continueOnError: true 
      inputs:
        source: specific
        project: build
        pipeline: Azure.sonic-buildimage.official.${{ platform }}
        runVersion: 'latestFromBranch'
        runBranch: '$(Build.SourceBranch)'
        path: download
        patterns: |
          **/target/versions/default/versions-docker
  - script: |
      set -ex
      az login -u $(ApplicationId) --service-principal --tenant $(AzureTenant) -p "$ApplicationKey"
      images=$(find download -name versions-docker | xargs -i cat {} | sort -u | grep -v "==$" | sed -e "s/amd64://" -e "s/arm64://" -e "s/armhf://" -e "s/==/@/")
      for i in $images
      do
        image_tag=$(echo $i | awk -F@ '{print$1}')
        az acr import -n PublicMirror --source docker.io/library/$i  --image $image_tag
      done
    env:
      ApplicationKey: '$(ApplicationKey)'
