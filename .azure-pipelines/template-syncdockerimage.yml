parameters:
- name: pipelines
  type: object
  default:
  - 138
  - 139
  - 140
  - 141
  - 142
  - 143
  - 146
  - 147
  - 148
  - 149

jobs:
- job: Build
  pool: sonicbld
  timeoutInMinutes: 120
  steps:
  - checkout: self
    clean: true
  - ${{ each pipe in parameters.pipelines }}:
    - task: DownloadPipelineArtifact@2
      displayName: Download ${{ pipe }} versions-docker
      continueOnError: true 
      inputs:
        source: specific
        project: build
        pipeline: ${{ pipe }}
        runVersion: 'latestFromBranch'
        runBranch: '$(Build.SourceBranch)'
        path: download
        patterns: |
          **/target/versions/default/versions-docker
  - script: |
      set -ex
      docker login $URL -u $(USER) -p $(PASSWD)
      images=$(find download -name versions-docker | xargs -i cat {} | sort -u | grep -v "==$" | sed -e "s/amd64://" -e "s/arm64://" -e "s/armhf://" -e "s/==/@/")
      for i in $images
      do
        docker pull $i
        image_tag=$(echo $i | awk -F@ '{print$1}')
        docker tag $i $URL/$image_tag
        docker push $URL/$image_tag
      done
    env:
      URL: $(url)
      USER: $(user)
      PASSWD: $(passwd)