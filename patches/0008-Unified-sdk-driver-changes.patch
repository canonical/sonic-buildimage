From e1a7459a65afafe39c29ab91fea2cf323d4361e7 Mon Sep 17 00:00:00 2001
From: Pavan Naregundi <pnaregundi@marvell.com>
Date: Mon, 19 Jun 2023 11:57:04 +0000
Subject: Unified sdk driver changes

Signed-off-by: Pavan Naregundi <pnaregundi@marvell.com>
---
 platform/marvell-arm64/platform.conf               | 14 ++++++++++----
 platform/marvell-arm64/prestera.mk                 |  2 +-
 platform/marvell-arm64/prestera/mrvl-prestera      |  1 -
 .../sonic-platform-db98cx8540-16cd/debian/rules    |  4 ++--
 .../sonic-platform-db98cx8580-32cd/debian/rules    |  4 ++--
 .../sonic-platform-nokia/debian/rules              |  5 ++---
 .../sonic-platform-rd98dx35xx-ext/debian/rules     |  4 ++--
 .../sonic-platform-rd98dx35xx/debian/rules         |  5 ++---
 8 files changed, 21 insertions(+), 18 deletions(-)
 delete mode 160000 platform/marvell-arm64/prestera/mrvl-prestera

diff --git a/platform/marvell-arm64/platform.conf b/platform/marvell-arm64/platform.conf
index b96c94b6c..325ebf6f6 100644
--- a/platform/marvell-arm64/platform.conf
+++ b/platform/marvell-arm64/platform.conf
@@ -27,10 +27,16 @@ fi
 PLATFORM=`sed -n 's/^onie_platform=\(.*\)/\1/p' $MACH_FILE`
 echo "Intalling SONiC from $install_env on Platform $PLATFORM"
 
+PLATFORM_AC5X=0
+
 case $PLATFORM in
     arm64-nokia_ixs7215_52xb-r0 | \
-    arm64-marvell_rd98DX35xx-r0) PLATFORM_AC5X=1 ;;
-    *) PLATFORM_AC5X=0;;
+    arm64-marvell_rd98DX35xx-r0) PLATFORM_AC5X=1
+				 plt_cmdline_linux="hugepages=4";;
+
+    arm64-marvell_rd98DX35xx_ext-r0 | \
+    arm64-marvell_db98cx8540_16cd-r0 | \
+    arm64-marvell_db98cx8580_32cd-r0) plt_cmdline_linux="hugepages=4";;
 esac
 
 if [ $PLATFORM_AC5X -eq 1 ]; then
@@ -195,8 +201,8 @@ prepare_boot_menu() {
     BORDER='echo "---------------------------------------------------";echo;'
     fw_setenv ${FW_ARG} print_menu $BORDER $BOOT1 $BOOT2 $BOOT3 $BORDER > /dev/null
 
-    fw_setenv ${FW_ARG} linuxargs "net.ifnames=0 loopfstype=squashfs loop=$image_dir/$FILESYSTEM_SQUASHFS systemd.unified_cgroup_hierarchy=0 varlog_size=$VAR_LOG ${extra_cmdline_linux} loglevel=4" > /dev/null
-    fw_setenv ${FW_ARG} linuxargs_old "net.ifnames=0 loopfstype=squashfs loop=$image_dir_old/$FILESYSTEM_SQUASHFS systemd.unified_cgroup_hierarchy=0 varlog_size=$VAR_LOG loglevel=4" > /dev/null
+    fw_setenv ${FW_ARG} linuxargs "net.ifnames=0 loopfstype=squashfs loop=$image_dir/$FILESYSTEM_SQUASHFS systemd.unified_cgroup_hierarchy=0 varlog_size=$VAR_LOG ${extra_cmdline_linux} ${plt_cmdline_linux} loglevel=4" > /dev/null
+    fw_setenv ${FW_ARG} linuxargs_old "net.ifnames=0 loopfstype=squashfs loop=$image_dir_old/$FILESYSTEM_SQUASHFS systemd.unified_cgroup_hierarchy=0 varlog_size=$VAR_LOG ${plt_cmdline_linux} loglevel=4" > /dev/null
     sonic_bootargs_old='setenv bootargs root='$demo_dev' rw rootwait rootfstype=ext4 panic=1 console=ttyS0,${baudrate} ${othbootargs} ${mtdparts} ${linuxargs_old}'
     fw_setenv ${FW_ARG} sonic_bootargs_old $sonic_bootargs_old > /dev/null || true
     sonic_boot_load_old=$(fw_printenv -n sonic_boot_load || true)
diff --git a/platform/marvell-arm64/prestera.mk b/platform/marvell-arm64/prestera.mk
index 466bc9b94..640867dea 100644
--- a/platform/marvell-arm64/prestera.mk
+++ b/platform/marvell-arm64/prestera.mk
@@ -1,3 +1,3 @@
 # Marvell Prestera
 export MRVL_PRESTERA_SRC_URL = https://github.com/Marvell-switching/mrvl-prestera.git
-export MRVL_PRESTERA_SRC_TAG = MRVL_PRESTERA_DRIVER_1.5
+export MRVL_PRESTERA_SRC_TAG = MRVL_PRESTERA_DRIVER_1.6
diff --git a/platform/marvell-arm64/prestera/mrvl-prestera b/platform/marvell-arm64/prestera/mrvl-prestera
deleted file mode 160000
index e7f48e0e7..000000000
--- a/platform/marvell-arm64/prestera/mrvl-prestera
+++ /dev/null
@@ -1 +0,0 @@
-Subproject commit e7f48e0e73233d28fda3a8ff3010ad10a67e9428
diff --git a/platform/marvell-arm64/sonic-platform-db98cx8540-16cd/debian/rules b/platform/marvell-arm64/sonic-platform-db98cx8540-16cd/debian/rules
index 5d1df2ad5..d66919a3b 100755
--- a/platform/marvell-arm64/sonic-platform-db98cx8540-16cd/debian/rules
+++ b/platform/marvell-arm64/sonic-platform-db98cx8540-16cd/debian/rules
@@ -34,7 +34,7 @@ build:
 		git clone ${MRVL_PRESTERA_SRC_URL}; \
 		cd mrvl-prestera && git checkout ${MRVL_PRESTERA_SRC_TAG} && cd ..; \
 		cd $(MOD_SRC_DIR); \
-		make modules -C $(KERNEL_SRC)/build M=$(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/ || exit 1; \
+		make modules -C $(KERNEL_SRC)/build M=$(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/ CONFIG_KM_MVPCI=y CONFIG_KM_MVINT=y || exit 1; \
 		python3 $${mod}/setup.py bdist_wheel -d $(MOD_SRC_DIR)/$${mod}; \
 	done)
 
@@ -55,7 +55,7 @@ binary-indep:
 		dh_installdirs -p$(PACKAGE_PRE_NAME)-$${mod} /lib/systemd/system; \
 		cp $(MOD_SRC_DIR)/$${mod}/$(SERVICE_DIR)/*.service debian/$(PACKAGE_PRE_NAME)-$${mod}/lib/systemd/system/; \
 		cp $(MOD_SRC_DIR)/$${mod}/$(UTILS_DIR)/* debian/$(PACKAGE_PRE_NAME)-$${mod}/usr/local/bin/; \
-		cp $(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/mvIntDrv.ko debian/$(PACKAGE_PRE_NAME)-$${mod}/$(KERNEL_SRC)/$(INSTALL_MOD_DIR); \
+		cp $(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/mvcpss.ko debian/$(PACKAGE_PRE_NAME)-$${mod}/$(KERNEL_SRC)/$(INSTALL_MOD_DIR); \
 		python3 $${mod}/setup.py install --root=$(MOD_SRC_DIR)/debian/$(PACKAGE_PRE_NAME)-$${mod} --install-layout=deb; \
 	done)
 
diff --git a/platform/marvell-arm64/sonic-platform-db98cx8580-32cd/debian/rules b/platform/marvell-arm64/sonic-platform-db98cx8580-32cd/debian/rules
index c9156bc79..f3bcfc539 100755
--- a/platform/marvell-arm64/sonic-platform-db98cx8580-32cd/debian/rules
+++ b/platform/marvell-arm64/sonic-platform-db98cx8580-32cd/debian/rules
@@ -33,7 +33,7 @@ build:
 		git clone ${MRVL_PRESTERA_SRC_URL}; \
 		cd mrvl-prestera && git checkout ${MRVL_PRESTERA_SRC_TAG} && cd ..; \
 		cd $(MOD_SRC_DIR); \
-		make modules -C $(KERNEL_SRC)/build M=$(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/ || exit 1; \
+		make modules -C $(KERNEL_SRC)/build M=$(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/ CONFIG_KM_MVPCI=y CONFIG_KM_MVINT=y || exit 1; \
 		python3 $${mod}/setup.py bdist_wheel -d $(MOD_SRC_DIR)/$${mod}; \
 	done)
 
@@ -54,7 +54,7 @@ binary-indep:
 		dh_installdirs -p$(PACKAGE_PRE_NAME)-$${mod} /lib/systemd/system; \
 		cp $(MOD_SRC_DIR)/$${mod}/$(SERVICE_DIR)/*.service debian/$(PACKAGE_PRE_NAME)-$${mod}/lib/systemd/system/; \
 		cp $(MOD_SRC_DIR)/$${mod}/$(UTILS_DIR)/* debian/$(PACKAGE_PRE_NAME)-$${mod}/usr/local/bin/; \
-		cp $(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/mvIntDrv.ko debian/$(PACKAGE_PRE_NAME)-$${mod}/$(KERNEL_SRC)/$(INSTALL_MOD_DIR); \
+		cp $(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/mvcpss.ko debian/$(PACKAGE_PRE_NAME)-$${mod}/$(KERNEL_SRC)/$(INSTALL_MOD_DIR); \
 		python3 $${mod}/setup.py install --root=$(MOD_SRC_DIR)/debian/$(PACKAGE_PRE_NAME)-$${mod} --install-layout=deb; \
 	done)
 
diff --git a/platform/marvell-arm64/sonic-platform-nokia/debian/rules b/platform/marvell-arm64/sonic-platform-nokia/debian/rules
index 0d792e337..38ff046c0 100755
--- a/platform/marvell-arm64/sonic-platform-nokia/debian/rules
+++ b/platform/marvell-arm64/sonic-platform-nokia/debian/rules
@@ -35,7 +35,7 @@ build:
 		git clone ${MRVL_PRESTERA_SRC_URL}; \
 		cd mrvl-prestera && git checkout ${MRVL_PRESTERA_SRC_TAG} && cd ..; \
 		cd $(MOD_SRC_DIR); \
-		make modules -C $(KERNEL_SRC)/build M=$(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/ || exit 1; \
+		make modules -C $(KERNEL_SRC)/build M=$(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/ CONFIG_KM_MVMBUS=y CONFIG_KM_MVINT=y || exit 1; \
 		make modules -C $(KERNEL_SRC)/build M=$(MOD_SRC_DIR)/$${mod}/modules || exit 1; \
 		python3 $${mod}/setup.py bdist_wheel -d $(MOD_SRC_DIR)/$${mod}; \
 	done)
@@ -58,8 +58,7 @@ binary-indep:
 		dh_installdirs -p$(PACKAGE_PRE_NAME)-$${mod} /lib/systemd/system; \
 		cp $(MOD_SRC_DIR)/$${mod}/$(SERVICE_DIR)/*.service debian/$(PACKAGE_PRE_NAME)-$${mod}/lib/systemd/system/; \
 		cp $(MOD_SRC_DIR)/$${mod}/$(UTILS_DIR)/* debian/$(PACKAGE_PRE_NAME)-$${mod}/usr/local/bin/; \
-		cp $(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/mvMbusDrv.ko debian/$(PACKAGE_PRE_NAME)-$${mod}/$(KERNEL_SRC)/$(INSTALL_MOD_DIR); \
-		cp $(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/mvIntDrv.ko debian/$(PACKAGE_PRE_NAME)-$${mod}/$(KERNEL_SRC)/$(INSTALL_MOD_DIR); \
+		cp $(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/mvcpss.ko debian/$(PACKAGE_PRE_NAME)-$${mod}/$(KERNEL_SRC)/$(INSTALL_MOD_DIR); \
 		cp $(MOD_SRC_DIR)/$${mod}/$(MODULE_DIR)/*.ko debian/$(PACKAGE_PRE_NAME)-$${mod}/$(KERNEL_SRC)/$(INSTALL_MOD_DIR); \
 		python3 $${mod}/setup.py install --root=$(MOD_SRC_DIR)/debian/$(PACKAGE_PRE_NAME)-$${mod} --install-layout=deb; \
 	done)
diff --git a/platform/marvell-arm64/sonic-platform-rd98dx35xx-ext/debian/rules b/platform/marvell-arm64/sonic-platform-rd98dx35xx-ext/debian/rules
index 755fb40f8..4de23cbd3 100755
--- a/platform/marvell-arm64/sonic-platform-rd98dx35xx-ext/debian/rules
+++ b/platform/marvell-arm64/sonic-platform-rd98dx35xx-ext/debian/rules
@@ -33,7 +33,7 @@ build:
 		git clone ${MRVL_PRESTERA_SRC_URL}; \
 		cd mrvl-prestera && git checkout ${MRVL_PRESTERA_SRC_TAG} && cd ..; \
 		cd $(MOD_SRC_DIR); \
-		make modules -C $(KERNEL_SRC)/build M=$(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/ || exit 1; \
+		make modules -C $(KERNEL_SRC)/build M=$(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/ CONFIG_KM_MVPCI=y CONFIG_KM_MVINT=y || exit 1; \
 		python3 $${mod}/setup.py bdist_wheel -d $(MOD_SRC_DIR)/$${mod}; \
 	done)
 
@@ -54,7 +54,7 @@ binary-indep:
 		dh_installdirs -p$(PACKAGE_PRE_NAME) /lib/systemd/system; \
 		cp $(MOD_SRC_DIR)/$${mod}/$(SERVICE_DIR)/*.service debian/$(PACKAGE_PRE_NAME)/lib/systemd/system/; \
 		cp $(MOD_SRC_DIR)/$${mod}/$(UTILS_DIR)/* debian/$(PACKAGE_PRE_NAME)/usr/local/bin/; \
-		cp $(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/mvIntDrv.ko debian/$(PACKAGE_PRE_NAME)/$(KERNEL_SRC)/$(INSTALL_MOD_DIR); \
+		cp $(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/mvcpss.ko debian/$(PACKAGE_PRE_NAME)/$(KERNEL_SRC)/$(INSTALL_MOD_DIR); \
 		python3 $${mod}/setup.py install --root=$(MOD_SRC_DIR)/debian/$(PACKAGE_PRE_NAME) --install-layout=deb; \
 	done)
 
diff --git a/platform/marvell-arm64/sonic-platform-rd98dx35xx/debian/rules b/platform/marvell-arm64/sonic-platform-rd98dx35xx/debian/rules
index aa65267fa..5604d6341 100755
--- a/platform/marvell-arm64/sonic-platform-rd98dx35xx/debian/rules
+++ b/platform/marvell-arm64/sonic-platform-rd98dx35xx/debian/rules
@@ -33,7 +33,7 @@ build:
 		git clone ${MRVL_PRESTERA_SRC_URL}; \
 		cd mrvl-prestera && git checkout ${MRVL_PRESTERA_SRC_TAG} && cd ..; \
 		cd $(MOD_SRC_DIR); \
-		make modules -C $(KERNEL_SRC)/build M=$(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/ || exit 1; \
+		make modules -C $(KERNEL_SRC)/build M=$(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/ CONFIG_KM_MVMBUS=y CONFIG_KM_MVINT=y || exit 1; \
 		python3 $${mod}/setup.py bdist_wheel -d $(MOD_SRC_DIR)/$${mod}; \
 	done)
 
@@ -52,8 +52,7 @@ binary-indep:
 		dh_installdirs -p$(PACKAGE_PRE_NAME) /$(KERNEL_SRC)/$(INSTALL_MOD_DIR); \
 		dh_installdirs -p$(PACKAGE_PRE_NAME) /usr/local/bin; \
 		cp $(MOD_SRC_DIR)/$${mod}/$(UTILS_DIR)/* debian/$(PACKAGE_PRE_NAME)/usr/local/bin/; \
-		cp $(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/mvMbusDrv.ko debian/$(PACKAGE_PRE_NAME)/$(KERNEL_SRC)/$(INSTALL_MOD_DIR); \
-		cp $(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/mvIntDrv.ko debian/$(PACKAGE_PRE_NAME)/$(KERNEL_SRC)/$(INSTALL_MOD_DIR); \
+		cp $(MOD_SRC_DIR)/$${mod}/$(PRESTERA_MODULE_DIR)/mvcpss.ko debian/$(PACKAGE_PRE_NAME)/$(KERNEL_SRC)/$(INSTALL_MOD_DIR); \
 		python3 $${mod}/setup.py install --root=$(MOD_SRC_DIR)/debian/$(PACKAGE_PRE_NAME) --install-layout=deb; \
 	done)
 
-- 
2.25.1

