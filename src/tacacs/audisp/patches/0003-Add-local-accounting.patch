From 86e616fc08a69a9465e64e02711cc0602533eb5b Mon Sep 17 00:00:00 2001
From: liuh-80 <58683130+liuh-80@users.noreply.github.com>
Date: Thu, 18 Nov 2021 15:20:17 +0800
Subject: [PATCH] Add local accounting.

---
 Makefile.am        |  3 +--
 Makefile.in        |  3 +--
 audisp-tacplus.c   | 14 ++++++++++++--
 local_accounting.c | 17 +++++++++++++++++
 local_accounting.h |  7 +++++++
 5 files changed, 38 insertions(+), 6 deletions(-)
 create mode 100644 local_accounting.c
 create mode 100644 local_accounting.h

diff --git a/Makefile.am b/Makefile.am
index cc85c0f..002ec8a 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -4,7 +4,7 @@
 EXTRA_DIST = ChangeLog README audisp_tacplus.spec \
 	audisp-tac_plus.conf audisp-tacplus.conf
 
-audisp_tacplus_SOURCES = audisp-tacplus.c password.c regex_helper.c trace.c
+audisp_tacplus_SOURCES = audisp-tacplus.c password.c regex_helper.c trace.c local_accounting.c
 audisp_tacplus_CFLAGS = -O
 audisp_tacplus_LDADD = -lauparse -ltacsupport -ltac
 sbin_PROGRAMS = audisp-tacplus
@@ -27,7 +27,6 @@ install-data-hook:
 	${INSTALL} -m 755 audisp-tacplus $(DESTDIR)$(sbindir)
 	${INSTALL} -d $(DESTDIR)$(sysconfdir)/audisp/plugins.d
 	${INSTALL} -d $(DESTDIR)$(sysconfdir)/audit/rules.d
-	${INSTALL} -m 600 audisp-tac_plus.conf $(DESTDIR)$(sysconfdir)/audisp/
 	${INSTALL} -m 644 audisp-tacplus.conf $(DESTDIR)$(sysconfdir)/audisp/plugins.d
 	${INSTALL} -m 644 -o 0 audisp-tacplus.rules $(DESTDIR)$(sysconfdir)/audit/rules.d
 
diff --git a/Makefile.in b/Makefile.in
index d124c16..5482a9a 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -345,8 +345,7 @@ target_alias = @target_alias@
 top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
-EXTRA_DIST = ChangeLog README audisp_tacplus.spec \
-	audisp-tac_plus.conf audisp-tacplus.conf
+EXTRA_DIST = ChangeLog README audisp_tacplus.spec audisp-tacplus.conf
 
 audisp_tacplus_SOURCES = audisp-tacplus.c
 audisp_tacplus_CFLAGS = -O
diff --git a/audisp-tacplus.c b/audisp-tacplus.c
index 50ec07e..ea294c8 100644
--- a/audisp-tacplus.c
+++ b/audisp-tacplus.c
@@ -72,6 +72,9 @@
 /* Remove password */
 #include "password.h"
 
+/* Local accounting */
+#include "local_accounting.h"
+
 #define _VMAJ 1
 #define _VMIN 0
 #define _VPATCH 0
@@ -322,7 +325,6 @@ send_tacacs_acct(char *user, char *tty, char *host, char *cmdmsg, int type,
 {
     int retval, srv_i, srv_fd;
 
-    check_and_load_changed_tacacs_config();
     for(srv_i = 0; srv_i < tac_srv_no; srv_i++) {
         srv_fd = tac_connect_single(tac_srv[srv_i].addr, tac_srv[srv_i].key, tac_source_addr, tac_timeout, __vrfname);
         if(srv_fd < 0) {
@@ -554,12 +556,20 @@ static void get_acct_record(auparse_state_t *au, int type)
         tlen += llen;
     }
 
+    check_and_load_changed_tacacs_config();
+
     /*
      * loguser is always set, we bail if not.  For ANOM_ABEND, tty may be
      *  unknown, and in some cases, host may be not be set.
      */
     remove_password(logbase);
-    send_tacacs_acct(loguser, tty?tty:"UNK", host, logbase, acct_type, taskno);
+    if (tacacs_ctrl & ACCOUNTING_FLAG_TACACS) {
+        send_tacacs_acct(loguser, tty?tty:"UNK", host, logbase, acct_type, taskno);
+    }
+    
+    if (tacacs_ctrl & ACCOUNTING_FLAG_LOCAL) {
+        accounting_to_syslog(loguser, tty?tty:"UNK", host, logbase, acct_type, taskno);
+    }
 
     if(freeloguser)
         free(loguser);
diff --git a/local_accounting.c b/local_accounting.c
new file mode 100644
index 0000000..3beaed3
--- /dev/null
+++ b/local_accounting.c
@@ -0,0 +1,17 @@
+#include <stdint.h>
+#include <stdarg.h>
+#include <stdio.h>
+#include <string.h>
+#include <syslog.h>
+#include <stdlib.h>
+
+#include "trace.h"
+
+/* Accounting log format. */
+#define ACCOUNTING_LOG_FORMAT "Accounting: user: %s, tty: %s, host: %s, command: %s, type: %d, task ID: %d"
+
+/* Write the accounting information to syslog. */
+void accounting_to_syslog(char *user, char *tty, char *host, char *cmdmsg, int type, uint16_t task_id)
+{
+    trace(ACCOUNTING_LOG_FORMAT, user, tty, host, cmdmsg, type, task_id);
+}
\ No newline at end of file
diff --git a/local_accounting.h b/local_accounting.h
new file mode 100644
index 0000000..9e880a7
--- /dev/null
+++ b/local_accounting.h
@@ -0,0 +1,7 @@
+#ifndef LOCAL_ACCOUNTING_H
+#define LOCAL_ACCOUNTING_H
+
+/* Write accounting information to syslog. */
+extern void accounting_to_syslog(char *user, char *tty, char *host, char *cmdmsg, int type, uint16_t task_id);
+
+#endif /* LOCAL_ACCOUNTING_H */
\ No newline at end of file
-- 
2.17.1.windows.2

