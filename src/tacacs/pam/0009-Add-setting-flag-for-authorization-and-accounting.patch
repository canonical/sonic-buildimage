From 73ac227e4924027d46e39c4f657d71aae5aa05b8 Mon Sep 17 00:00:00 2001
From: liuh-80 <58683130+liuh-80@users.noreply.github.com>
Date: Wed, 29 Sep 2021 15:32:10 +0800
Subject: [PATCH 3/3] Add setting flag for authorization and accounting.

---
 support.c |  8 ++++++++
 support.h | 10 +++++++++-
 2 files changed, 17 insertions(+), 1 deletion(-)

diff --git a/support.c b/support.c
index 6b2e72d..e94c79b 100644
--- a/support.c
+++ b/support.c
@@ -343,6 +343,14 @@ int _pam_parse_arg (const char *arg, char* current_secret, uint current_secret_b
         /* source ip for the packets */
         strncpy (tac_source_ip, arg + strlen("source_ip="), sizeof(tac_source_ip));
         set_source_ip (tac_source_ip);
+    } else if (!strcmp (arg, "local_accounting")) {
+        ctrl |= ACCOUNTING_FLAG_LOCAL;
+    } else if (!strcmp (arg, "tacacs_accounting")) {
+        ctrl |= ACCOUNTING_FLAG_TACACS;
+    } else if (!strcmp (arg, "local_authorization")) {
+        ctrl |= AUTHORIZATION_FLAG_LOCAL;
+    } else if (!strcmp (arg, "tacacs_authorization")) {
+        ctrl |= AUTHORIZATION_FLAG_TACACS;
     } else {
         _pam_log (LOG_WARNING, "unrecognized option: %s", arg);
     }
diff --git a/support.h b/support.h
index bdb60b4..5fce87e 100644
--- a/support.h
+++ b/support.h
@@ -32,6 +32,14 @@
 #define PAM_TAC_USE_FIRST_PASS 0x04
 #define PAM_TAC_TRY_FIRST_PASS 0x08
 
+/* accounting setting flag */
+#define ACCOUNTING_FLAG_LOCAL  0x10
+#define ACCOUNTING_FLAG_TACACS 0x20
+
+/* authorization setting flag */
+#define AUTHORIZATION_FLAG_LOCAL  0x40
+#define AUTHORIZATION_FLAG_TACACS 0x80
+
 typedef struct {
     struct addrinfo *addr;
     char key[256];
@@ -45,7 +53,7 @@ extern char *__vrfname;
 extern char tac_service[64];
 extern char tac_protocol[64];
 extern char tac_prompt[64];
-extern struct addrinfo tac_source_addr;
+extern struct addrinfo tac_source_addr;
 
 int _pam_parse (int, const char **);
 unsigned long _resolve_name (char *);
-- 
2.17.1.windows.2

