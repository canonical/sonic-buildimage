From 6620d4778fe36c89ce2e95d6932338cefc90df7d Mon Sep 17 00:00:00 2001
From: Joe LeVeque <jolevequ@microsoft.com>
Date: Fri, 17 May 2019 21:53:52 +0000
Subject: [PATCH 2/3] Bugfix: Ensure HAVE_SO_BINDTODEVICE has a chance to be
 defined before it is referenced

---
 includes/osdep.h | 237 +++++++++++++++++++++++------------------------
 1 file changed, 117 insertions(+), 120 deletions(-)

diff --git a/includes/osdep.h b/includes/osdep.h
index 0742858..29c5328 100644
--- a/includes/osdep.h
+++ b/includes/osdep.h
@@ -47,6 +47,123 @@
 #define BYTE_ORDER DHCP_BYTE_ORDER
 #endif /* BYTE_ORDER */
 
+#if !defined (TIME_MAX)
+# define TIME_MAX 2147483647
+#endif
+
+/* snprintf/vsnprintf hacks.  for systems with no libc versions only. */
+#ifdef NO_SNPRINTF
+  extern int isc_print_snprintf(char *, size_t, const char *, ...);
+  extern int isc_print_vsnprintf(char *, size_t, const char *, va_list ap);
+# define snprintf  isc_print_snprintf
+# define vsnprintf isc_print_vsnprintf
+#endif
+
+/* If we don't have a DLPI packet filter, we have to filter in userland.
+   Probably not worth doing, actually. */
+#if defined (USE_DLPI_RECEIVE) && !defined (USE_DLPI_PFMOD)
+#  define USERLAND_FILTER
+#endif
+
+/* jmp_buf is assumed to be a struct unless otherwise defined in the
+   system header. */
+#ifndef jbp_decl
+# define jbp_decl(x)	jmp_buf *x
+#endif
+#ifndef jref
+# define jref(x)	(&(x))
+#endif
+#ifndef jdref
+# define jdref(x)	(*(x))
+#endif
+#ifndef jrefproto
+# define jrefproto	jmp_buf *
+#endif
+
+#ifndef BPF_FORMAT
+# define BPF_FORMAT "/dev/bpf%d"
+#endif
+
+#if defined (F_SETFD) && !defined (HAVE_SETFD)
+# define HAVE_SETFD
+#endif
+
+#if defined (IFF_POINTOPOINT) && !defined (HAVE_IFF_POINTOPOINT)
+# define HAVE_IFF_POINTOPOINT
+#endif
+
+#if defined (AF_LINK) && !defined (HAVE_AF_LINK)
+# define HAVE_AF_LINK
+#endif
+
+#if defined (ARPHRD_TUNNEL) && !defined (HAVE_ARPHRD_TUNNEL)
+# define HAVE_ARPHRD_TUNNEL
+#endif
+
+#if defined (ARPHRD_LOOPBACK) && !defined (HAVE_ARPHRD_LOOPBACK)
+# define HAVE_ARPHRD_LOOPBACK
+#endif
+
+#if defined (ARPHRD_ROSE) && !defined (HAVE_ARPHRD_ROSE)
+# define HAVE_ARPHRD_ROSE
+#endif
+
+#if defined (ARPHRD_IRDA) && !defined (HAVE_ARPHRD_IRDA)
+# define HAVE_ARPHRD_IRDA
+#endif
+
+#if defined (ARPHRD_SIT) && !defined (HAVE_ARPHRD_SIT)
+# define HAVE_ARPHRD_SIT
+#endif
+
+#if defined (ARPHRD_IEEE1394) & !defined (HAVE_ARPHRD_IEEE1394)
+# define HAVE_ARPHRD_IEEE1394
+#endif
+
+#if defined (ARPHRD_IEEE802) && !defined (HAVE_ARPHRD_IEEE802)
+# define HAVE_ARPHRD_IEEE802
+#endif
+
+#if defined (ARPHRD_IEEE802_TR) && !defined (HAVE_ARPHRD_IEEE802_TR)
+# define HAVE_ARPHRD_IEEE802_TR
+#endif
+
+#if defined (ARPHRD_FDDI) && !defined (HAVE_ARPHRD_FDDI)
+# define HAVE_ARPHRD_FDDI
+#endif
+
+#if defined (ARPHRD_AX25) && !defined (HAVE_ARPHRD_AX25)
+# define HAVE_ARPHRD_AX25
+#endif
+
+#if defined (ARPHRD_NETROM) && !defined (HAVE_ARPHRD_NETROM)
+# define HAVE_ARPHRD_NETROM
+#endif
+
+#if defined (ARPHRD_METRICOM) && !defined (HAVE_ARPHRD_METRICOM)
+# define HAVE_ARPHRD_METRICOM
+#endif
+
+#if defined (AF_LINK) && !defined (HAVE_AF_LINK)
+# define HAVE_AF_LINK
+#endif
+
+/* Linux needs to define SHUT_* in /usr/include/sys/socket.h someday... */
+#if !defined (SHUT_RD)
+# define SHUT_RD 0
+#endif
+
+#if !defined (SOCKLEN_T)
+# define SOCKLEN_T socklen_t
+#elif defined(_AIX)
+#undef SOCKLEN_T
+#define SOCKLEN_T socklen_t
+#endif
+
+#if !defined (STDERR_FILENO)
+# define STDERR_FILENO 2
+#endif
+
 /* Porting::
 
    If you add a new network API, you must add a check for it below: */
@@ -78,18 +195,6 @@
 # endif
 #endif
 
-#if !defined (TIME_MAX)
-# define TIME_MAX 2147483647
-#endif
-
-/* snprintf/vsnprintf hacks.  for systems with no libc versions only. */
-#ifdef NO_SNPRINTF
-  extern int isc_print_snprintf(char *, size_t, const char *, ...);
-  extern int isc_print_vsnprintf(char *, size_t, const char *, va_list ap);
-# define snprintf  isc_print_snprintf
-# define vsnprintf isc_print_vsnprintf
-#endif
-
 /* Porting::
 
    If you add a new network API, and have it set up so that it can be
@@ -138,10 +243,6 @@
 #  define USE_UPF_RECEIVE
 #endif
 
-#if defined (SO_BINDTODEVICE) && !defined (HAVE_SO_BINDTODEVICE)
-# define HAVE_SO_BINDTODEVICE
-#endif
-
 /* Porting::
 
    If you add support for sending packets directly out an interface,
@@ -182,109 +283,5 @@
 #  define PACKET_DECODING
 #endif
 
-/* If we don't have a DLPI packet filter, we have to filter in userland.
-   Probably not worth doing, actually. */
-#if defined (USE_DLPI_RECEIVE) && !defined (USE_DLPI_PFMOD)
-#  define USERLAND_FILTER
-#endif
-
-/* jmp_buf is assumed to be a struct unless otherwise defined in the
-   system header. */
-#ifndef jbp_decl
-# define jbp_decl(x)	jmp_buf *x
-#endif
-#ifndef jref
-# define jref(x)	(&(x))
-#endif
-#ifndef jdref
-# define jdref(x)	(*(x))
-#endif
-#ifndef jrefproto
-# define jrefproto	jmp_buf *
-#endif
-
-#ifndef BPF_FORMAT
-# define BPF_FORMAT "/dev/bpf%d"
-#endif
-
-#if defined (F_SETFD) && !defined (HAVE_SETFD)
-# define HAVE_SETFD
-#endif
-
-#if defined (IFF_POINTOPOINT) && !defined (HAVE_IFF_POINTOPOINT)
-# define HAVE_IFF_POINTOPOINT
-#endif
-
-#if defined (AF_LINK) && !defined (HAVE_AF_LINK)
-# define HAVE_AF_LINK
-#endif
-
-#if defined (ARPHRD_TUNNEL) && !defined (HAVE_ARPHRD_TUNNEL)
-# define HAVE_ARPHRD_TUNNEL
-#endif
-
-#if defined (ARPHRD_LOOPBACK) && !defined (HAVE_ARPHRD_LOOPBACK)
-# define HAVE_ARPHRD_LOOPBACK
-#endif
-
-#if defined (ARPHRD_ROSE) && !defined (HAVE_ARPHRD_ROSE)
-# define HAVE_ARPHRD_ROSE
-#endif
-
-#if defined (ARPHRD_IRDA) && !defined (HAVE_ARPHRD_IRDA)
-# define HAVE_ARPHRD_IRDA
-#endif
-
-#if defined (ARPHRD_SIT) && !defined (HAVE_ARPHRD_SIT)
-# define HAVE_ARPHRD_SIT
-#endif
-
-#if defined (ARPHRD_IEEE1394) & !defined (HAVE_ARPHRD_IEEE1394)
-# define HAVE_ARPHRD_IEEE1394
-#endif
-
-#if defined (ARPHRD_IEEE802) && !defined (HAVE_ARPHRD_IEEE802)
-# define HAVE_ARPHRD_IEEE802
-#endif
-
-#if defined (ARPHRD_IEEE802_TR) && !defined (HAVE_ARPHRD_IEEE802_TR)
-# define HAVE_ARPHRD_IEEE802_TR
-#endif
-
-#if defined (ARPHRD_FDDI) && !defined (HAVE_ARPHRD_FDDI)
-# define HAVE_ARPHRD_FDDI
-#endif
-
-#if defined (ARPHRD_AX25) && !defined (HAVE_ARPHRD_AX25)
-# define HAVE_ARPHRD_AX25
-#endif
-
-#if defined (ARPHRD_NETROM) && !defined (HAVE_ARPHRD_NETROM)
-# define HAVE_ARPHRD_NETROM
-#endif
-
-#if defined (ARPHRD_METRICOM) && !defined (HAVE_ARPHRD_METRICOM)
-# define HAVE_ARPHRD_METRICOM
-#endif
-
-#if defined (AF_LINK) && !defined (HAVE_AF_LINK)
-# define HAVE_AF_LINK
-#endif
-
-/* Linux needs to define SHUT_* in /usr/include/sys/socket.h someday... */
-#if !defined (SHUT_RD)
-# define SHUT_RD 0
-#endif
-
-#if !defined (SOCKLEN_T)
-# define SOCKLEN_T socklen_t
-#elif defined(_AIX)
-#undef SOCKLEN_T
-#define SOCKLEN_T socklen_t
-#endif
-
-#if !defined (STDERR_FILENO)
-# define STDERR_FILENO 2
-#endif
 
 #endif /* __ISC_DHCP_OSDEP_H__ */
-- 
2.25.1

