From 2a08d95aaf899bb353f69326427e036b33a6293c Mon Sep 17 00:00:00 2001
From: xuliping <xuliping@microsoft.com>
Date: Thu, 7 Mar 2024 10:24:59 +0000
Subject: [PATCH] update

---
 bgpd/bgp_route.c      |  6 +++---
 bgpd/bgp_updgrp_adv.c | 10 ++++++----
 2 files changed, 9 insertions(+), 7 deletions(-)

diff --git a/bgpd/bgp_route.c b/bgpd/bgp_route.c
index 55db3fc7a..f7219ce94 100644
--- a/bgpd/bgp_route.c
+++ b/bgpd/bgp_route.c
@@ -2921,11 +2921,11 @@ void subgroup_process_announce_selected(struct update_subgroup *subgrp,
 					struct attr *adv_attr =
 						bgp_attr_intern(&attr);
 
-					if (!bgp_adj_out_set_subgroup(dest,
+					bgp_adj_out_set_subgroup(dest,
 								      subgrp,
 								      adv_attr,
-								      selected))
-						bgp_attr_unintern(&adv_attr);
+								      selected);
+					bgp_attr_unintern(&adv_attr);
 				} else {
 					bgp_adj_out_unset_subgroup(
 						dest, subgrp, 1, addpath_tx_id);
diff --git a/bgpd/bgp_updgrp_adv.c b/bgpd/bgp_updgrp_adv.c
index 364454e06..42ce5c60f 100644
--- a/bgpd/bgp_updgrp_adv.c
+++ b/bgpd/bgp_updgrp_adv.c
@@ -670,7 +670,7 @@ void subgroup_announce_table(struct update_subgroup *subgrp,
 {
 	struct bgp_dest *dest;
 	struct bgp_path_info *ri;
-	struct attr attr;
+	struct attr attr = {0};
 	struct peer *peer;
 	afi_t afi;
 	safi_t safi;
@@ -721,10 +721,10 @@ void subgroup_announce_table(struct update_subgroup *subgrp,
 						struct attr *adv_attr =
 							bgp_attr_intern(&attr);
 
-						if (!bgp_adj_out_set_subgroup(
+						bgp_adj_out_set_subgroup(
 							dest, subgrp, adv_attr,
-							ri))
-							bgp_attr_unintern(&adv_attr);
+							ri);
+						bgp_attr_unintern(&adv_attr);
 					} else
 						bgp_adj_out_unset_subgroup(
 							dest, subgrp, 1,
@@ -732,6 +732,7 @@ void subgroup_announce_table(struct update_subgroup *subgrp,
 								peer, afi,
 								safi_rib,
 								&ri->tx_addpath));
+						bgp_attr_flush(&attr);
 				}
 			} else {
 				/* If default originate is enabled for
@@ -751,6 +752,7 @@ void subgroup_announce_table(struct update_subgroup *subgrp,
 					bgp_addpath_id_for_peer(
 						peer, afi, safi_rib,
 						&ri->tx_addpath));
+				bgp_attr_flush(&attr);
 			}
 		}
 	}
-- 
2.25.1

