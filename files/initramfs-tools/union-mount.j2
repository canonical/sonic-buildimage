#!/bin/sh -e
case $1 in
  prereqs)
    exit 0
    ;;
esac

## Mount the aufs file system: rw layer over squashfs
mkdir -p ${rootmnt}/host/image-%%IMAGE_VERSION%%/rw
mount -n -o dirs=${rootmnt}/host/image-%%IMAGE_VERSION%%/rw:${rootmnt}=ro -t aufs root-aufs ${rootmnt}
## Check if the root block device is still there
[ -b ${ROOT} ] || mdev -s
## Mount the raw partition again
mount ${ROOT} ${rootmnt}/host
## Mount the working directory of docker engine in the raw partition, bypass the aufs
mkdir -p ${rootmnt}/var/lib/docker
mount --bind ${rootmnt}/host/image-%%IMAGE_VERSION%%/{{ DOCKERFS_DIR }} ${rootmnt}/var/lib/docker
## Mount the boot directory in the raw partition, bypass the aufs
mkdir -p ${rootmnt}/boot
mount --bind ${rootmnt}/host/image-%%IMAGE_VERSION%%/boot ${rootmnt}/boot
## Mount loop device for /var/log
[ -f ${rootmnt}/host/disk-img/var-log.ext4 ] && mount -t ext4 -o loop,rw ${rootmnt}/host/disk-img/var-log.ext4 ${rootmnt}/var/log
