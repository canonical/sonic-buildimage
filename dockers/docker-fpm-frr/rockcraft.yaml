name: docker-fpm-frr
summary: SONiC fpm-frr container
description: A Chiselled rock for SONiC fpm-frr container
version: "1.0.0"

# Use a "bare" base for an even smaller rock
base: ubuntu@22.04 

# Meeting requirement R1 by making sure the rock builds on Jammy
build-base: ubuntu@22.04

license: Apache-2.0

# Target architecture is amd64
platforms:
  amd64:  # Make sure this value matches your computer's architecture

services:
  supervisor:
    command: "/usr/bin/docker_init.sh"
    startup: enabled
    override: replace

# FROM docker-swss-layer-jammy 

parts:
  install-libnl-3-200_3.5.0-1_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/libnl-3-200_3.5.0-1_amd64.deb

  install-libnl-route-3-200_3.5.0-1_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/libnl-route-3-200_3.5.0-1_amd64.deb

  install-libnl-genl-3-200_3.5.0-1_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/libnl-genl-3-200_3.5.0-1_amd64.deb

  install-libnl-nf-3-200_3.5.0-1_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/libnl-nf-3-200_3.5.0-1_amd64.deb

  install-libnl-cli-3-200_3.5.0-1_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/libnl-cli-3-200_3.5.0-1_amd64.deb

  install-libyang_1.0.73_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/libyang_1.0.73_amd64.deb

  install-libyang2_2.0.112-6_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/libyang2_2.0.112-6_amd64.deb

  install-libswsscommon_1.0.0_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/libswsscommon_1.0.0_amd64.deb

  install-libyang-cpp_1.0.73_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/libyang-cpp_1.0.73_amd64.deb

  install-python3-yang_1.0.73_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/python3-yang_1.0.73_amd64.deb 

  install-python3-swsscommon_1.0.0_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/python3-swsscommon_1.0.0_amd64.deb

  install-sonic-db-cli_1.0.0_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/sonic-db-cli_1.0.0_amd64.deb

  install-sonic-eventd_1.0.0-0_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/sonic-eventd_1.0.0-0_amd64.deb

  # docker-swss-layer-jammy packages
  install-swss_1.0.0_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/swss_1.0.0_amd64.deb

  # docker-orchagent specific packages
  install-libprotobuf32_3.21.12-3_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/libprotobuf32_3.21.12-3_amd64.deb

  install-libprotobuf-lite32_3.21.12-3_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/libprotobuf-lite32_3.21.12-3_amd64.deb

  install-python3-protobuf_3.21.12-3_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/python3-protobuf_3.21.12-3_amd64.deb

  install-libsairedis_1.0.0_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/libsairedis_1.0.0_amd64.deb

  install-libsaimetadata_1.0.0_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/libsaimetadata_1.0.0_amd64.deb

  install-libteam5_1.31-1_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/libteam5_1.31-1_amd64.deb

  install-libteamdctl0_1.31-1_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/libteamdctl0_1.31-1_amd64.deb

  install-libdashapi_1.0.0_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/libdashapi_1.0.0_amd64.deb

  install-sonic-rsyslog-plugin_1.0.0-0_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/sonic-rsyslog-plugin_1.0.0-0_amd64.deb

  install-libsnmp40_5.9.1+dfsg-1ubuntu2.6_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/libsnmp40_5.9.1+dfsg-1ubuntu2.6_amd64.deb

  install-libsnmp-base_5.9.1+dfsg-1ubuntu2.6_all:
    plugin: dump
    source-type: deb
    source: ./debs/libsnmp-base_5.9.1+dfsg-1ubuntu2.6_all.deb

  install-frr_8.5.4-sonic-0_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/frr_8.5.4-sonic-0_amd64.deb

  install-frr-snmp_8.5.4-sonic-0_amd64:
    plugin: dump
    source-type: deb
    source: ./debs/frr-snmp_8.5.4-sonic-0_amd64.deb

  install-packages:
    plugin: nil
    stage-packages:
      - rsyslog
      - python3.10
      - libpython3.10
      # package dependencies
      - libhiredis0.14
      - libzmq5
      - libboost-serialization1.74.0
      - libuuid1
      # from docker-swss-layer-jammy
      - iputils-ping
      # fpm-frr dependencies
      - libc-ares2
      - iproute2
      - logrotate
      - libunwind8
      - jq
      - libjson-c5
      # zebra dependencies
      - libwrap0
      - libperl5.34

  install-python:
    plugin: python
    source: .
    python-packages:
      # inherited from docker-config-engine-jammy
      - ./python-wheels/sonic_py_common-1.0-py3-none-any.whl
      - ./python-wheels/sonic_yang_mgmt-1.0-py3-none-any.whl
      - ./python-wheels/sonic_yang_models-1.0-py3-none-any.whl
      - ./python-wheels/sonic_containercfgd-1.0-py3-none-any.whl
      - ./python-wheels/sonic_config_engine-1.0-py3-none-any.whl
      # supervisor
      - supervisor==4.2.5
      - supervisord-dependent-startup==1.4.0
      # from docker-orchagent
      - j2cli
      - ./python-wheels/sonic_bgpcfgd-1.0-py3-none-any.whl
      - ./python-wheels/sonic_frr_mgmt_framework-1.0-py3-none-any.whl

    stage-packages:
      - python3.10-venv
    organize:
      bin/supervisord: usr/local/bin/supervisord

  install-common-files:
    plugin: nil
    source: .
    source-type: local
    after: [install-packages, install-python]
    override-prime: |
      # common - manifest.json
      cp ${CRAFT_PROJECT_DIR}/manifest.json              ./ 

      # common - templates&scripts (from docker-config-engine-jammy
      mkdir -p usr/share/sonic/templates/
      mkdir -p usr/share/sonic/scripts/
      cp ${CRAFT_PROJECT_DIR}/files/swss_vars.j2         usr/share/sonic/templates/
      cp ${CRAFT_PROJECT_DIR}/files/readiness_probe.sh   usr/bin/
      cp ${CRAFT_PROJECT_DIR}/files/container_startup.py usr/share/sonic/scripts/
 
      # common - rsyslog
      mkdir -p etc/rsyslog.d/
      cp ${CRAFT_PROJECT_DIR}/etc/rsyslog.d/00-load-omprog.conf   etc/rsyslog.d/
      cp ${CRAFT_PROJECT_DIR}/etc/rsyslog.conf                    etc/
      # orchagent specific rsyslog
      cp ${CRAFT_PROJECT_DIR}/etc/bgp_events.conf                 etc/rsyslog.d/

      # common - supervisor config files
      mkdir -p etc/supervisor/conf.d
      mkdir -p var/log/supervisor

      cp ${CRAFT_PROJECT_DIR}/etc/supervisor/supervisord.conf     etc/supervisor/

      # common - supervisor related
      mkdir -p usr/share/sonic/templates
      #cp ${CRAFT_PROJECT_DIR}/supervisord.conf.j2     usr/share/sonic/templates/

      mkdir -p etc/sysctl.d/
      cp ${CRAFT_PROJECT_DIR}/files/sysctl-net.conf               etc/sysctl.d/
      cp ${CRAFT_PROJECT_DIR}/files/supervisor-proc-exit-listener usr/bin/

      # docker-orchagent specifc
      mkdir -p usr/bin
      cp ${CRAFT_PROJECT_DIR}/docker_init.sh           usr/bin/
      cp ${CRAFT_PROJECT_DIR}/TSA                      usr/bin/
      cp ${CRAFT_PROJECT_DIR}/TSB                      usr/bin/ 
      cp ${CRAFT_PROJECT_DIR}/TSC                      usr/bin/
      cp ${CRAFT_PROJECT_DIR}/TS                       usr/bin/
      cp ${CRAFT_PROJECT_DIR}/zsocket.sh               usr/bin/

      # snmp
      mkdir -p etc/snmp/
      cp ${CRAFT_PROJECT_DIR}/snmp.conf                etc/snmp/frr.conf

      # frr specific templates
      cp -r ${CRAFT_PROJECT_DIR}/frr/*                 usr/share/sonic/templates/

  add-user:
    plugin: nil
    after: [install-common-files]

    overlay-script: |
      #syslog user
      groupadd -R $CRAFT_OVERLAY syslog
      useradd -R $CRAFT_OVERLAY -M -r --system -g adm syslog

      #frr
      groupadd -R $CRAFT_OVERLAY frr
      useradd -R $CRAFT_OVERLAY -M -r  -g  frr frr
      groupadd -R $CRAFT_OVERLAY frrvty
      usermod -R $CRAFT_OVERLAY -a -G frrvty frr

    prime:
      - etc/passwd
      - etc/group
